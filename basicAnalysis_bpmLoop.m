close all;
%%

dataSetNames = {
    '20141205_0942_TimingScans_FF_K1Gain_0_K2Gain_0_end',...
    '20141205_0942_TimingScans_FF_K1Gain_50_K2Gain_0_end',...
    '20141205_1015_TimingScans_FF_K1Gain_-50_K2Gain_0_end',...
    '20141205_1020_TimingScans_FF_K1Gain_0_K2Gain_50_end',...
    '20141205_1023_TimingScans_FF_K1Gain_0_K2Gain_-50_end',...
    '20141205_1025_TimingScans_FF_K1Gain_0_K2Gain_0_end',...
};
dataSetLabels = {
    'No Feedforward',...
    'Max Gain K1',...
    'Min Gain K1',...
    'Max Gain K2',...
    'Min Gain K2',...
    'No feedforward',...
};
ccRange = 440:460;
cbRange = 350:370;


% dataSetNames = {
%     '20141128_1140_ConstKick_Gate_390_420_DAC1_0_DAC2_0',...
%     '20141128_1140_ConstKick_Gate_390_420_DAC1_800_DAC2_-800',...
%     '20141128_1140_ConstKick_Gate_390_420_DAC1_-800_DAC2_800',...
% };
% dataSetLabels = {
% ...%    'No Kick',...
%     'No Kick',...
%    ... %'K1=+800, K2=0',...
%     ...%'K1=0, K2=-800',...
%     'K1=+800, K2=-800',...
%     'K1=-800, K2=+800',...
% };
% ccRange = 440:460;
% cbRange = 350:370;

% dataSetNames = {
%     ...%'20141210_1922_R56_+0.3_Gate_375_435_ConstK1_0_ConstK2_0',...
%     '20141210_1915_R56_+0.3_Gate_350_410_ConstK1_0_ConstK2_0',...
%     '20141210_1922_R56_+0.3_Gate_375_435_ConstK1_800_ConstK2_0',...
%     '20141210_1922_R56_+0.3_Gate_375_435_ConstK1_0_ConstK2_-800',...
%     '20141210_1915_R56_+0.3_Gate_375_435_ConstK1_800_ConstK2_-800',...
%     '20141210_1915_R56_+0.3_Gate_375_435_ConstK1_-800_ConstK2_800',...
% };
% dataSetLabels = {
% ...%    'No Kick',...
%     'No Kick',...
%     'K1=+800, K2=0',...
%     'K1=0, K2=-800',...
%     'K1=+800, K2=-800',...
%     'K1=-800, K2=+800',...
% };
% ccRange = 440:460;
% cbRange = 350:370;

% dataSetNames = {
%     ...%'20141210_1922_R56_+0.3_Gate_375_435_ConstK1_0_ConstK2_0',...
%     '20141210_1915_R56_+0.3_Gate_350_410_ConstK1_0_ConstK2_0',...
%     '20141210_1922_R56_+0.3_Gate_375_435_ConstK1_800_ConstK2_0',...
%     '20141210_1922_R56_+0.3_Gate_375_435_ConstK1_0_ConstK2_-800',...
%     '20141210_1915_R56_+0.3_Gate_375_435_ConstK1_800_ConstK2_-800',...
%     '20141210_1915_R56_+0.3_Gate_375_435_ConstK1_-800_ConstK2_800',...
% };
% 
% dataSetLabels = {
% ...%    'No Kick',...
%     'No Kick',...
%     'K1=+800, K2=0',...
%     'K1=0, K2=-800',...
%     'K1=+800, K2=-800',...
%     'K1=-800, K2=+800',...
% };
% ccRange = 440:460;
% cbRange = 350:370;

dataSetColours = [...
    0, 0, 0;...
    0, 0, 1;...
    1, 0, 0;...
    0, 0, 1;...
    1, 0, 0;...
    0, 0, 0];    
    
dataSetStyles = {...
    '-';...
    '-';...
    '-';...
    '--';...
    '--';...
    '--'};    

dataSetWidths = [...
    2,...
    2,...
    2,...    
    2,...
    2,...
    2];

bpmsToPlot = {
    'CC.SVBPM0235H',...
    'CC.SVBPM0275H',...
    'CC.SVBPM0365H',...
    'CC.SVBPM0435H',...
    'CC.SVBPI0535H',...
    'CC.SVBPI0645H',...
    'CC.SVBPI0685H',...
    'CC.SVBPI0735H',...
    'CC.SVBPM0845H',...
    'CC.SVBPM0930H',...
    'CB.SVBPM0150H',...
    'CB.SVBPS0210H',...
    'CB.SVBPS0250H',...
    'CB.SVBPS0310H',...
    'CB.SVBPS0350H',...
    'CB.SVBPS0410H',...
    'CB.SVBPS0450H',...
    'CB.SVBPS0510H',...
    'CB.SVBPS0550H',...
    'CB.SVBPS0610H',...
    'CB.SVBPS0650H',...
    'CB.SVBPS0710H',...
    'CB.SVBPS0750H',...
    'CB.SVBPS0810H',...
    'CB.SVBPS0850H',...
    'CB.SVBPS0910H',...
    'CB.SVBPS0950H',...
    'CB.SVBPM1030H'...
};
ccIndexes = 1:10;
cbIndexes = 11:28;

%%

nDataSets = length(dataSetNames);
nBPMsToPlot = length(bpmsToPlot);
nBPMSamples = 768;

processedData = loadProcessedData(dataSetNames);

% baseDir = '/home/jack/PhaseFeedforward/CTFData/';
% processedDir = 'processed/';
% processedData = cell(1,nDataSets);
% for i=1:nDataSets
%     yearMonth = dataSetNames{i}(1:6);
%     dataPath = [baseDir yearMonth '/' dataSetNames{i} '/' processedDir dataSetNames{i} '.mat'];
%     tmpData = load(dataPath);
%     processedData{i} = tmpData.processedData;
% end

%% Analysis: BPMs compared to first data set
bpmPositions = NaN*ones(nBPMsToPlot,nDataSets,nBPMSamples);
bpmErrors = NaN*ones(nBPMsToPlot,nDataSets,nBPMSamples);
for b=1:nBPMsToPlot
    figure;
    for i=2:nDataSets
        tmpZero = eval(['processedData{1}.bpmData.' bpmsToPlot{b} '.Samples.samples']);
        zeroKick = nanmean(tmpZero);
        zeroKickErr = nanstd(tmpZero)./sqrt(sum(~isnan(tmpZero)));
        bpmPositions(b,1,:) = zeroKick;
        bpmErrors(b,1,:) = zeroKickErr;
        
        tmpData = eval(['processedData{i}.bpmData.' bpmsToPlot{b} '.Samples.samples']);
        
%         plot(tmpData','Color',dataSetColours(i,:));
        
        toPlot = nanmean(tmpData);
        toPlot = toPlot - zeroKick;
        %toPlot = toPlot - toPlot(410);
        bpmPositions(b,i,:) = toPlot;
        
        plotError = nanstd(tmpData)./sqrt(sum(~isnan(tmpData)));
        bpmErrors(b,i,:) = plotError;
        
        plot(toPlot,'Color',dataSetColours(i,:),'LineStyle',dataSetStyles{i},'LineWidth',dataSetWidths(i))
        %shadedErrorBar(1:length(tmpData),toPlot,plotError)
        hold all;
    end
    title(sprintf('%s %s',bpmsToPlot{b}));
    legend(dataSetLabels{2:nDataSets});
    xlabel('Sample No.')
    ylabel('Position [mm]');

    hold off;
%     input('enter');
    
%     plot(tmpZero');
%     title(sprintf('%s %s',bpmsToPlot{b}));
%     input('enter');


%     title(bpmsToPlot{b});
    %xlim([410 490])
    %plot(bpmPositions{2}+bpmPositions{3},'k','LineWidth',2);
    %legend({dataSetLabels{2:nDataSets} 'K1 + K2'});

end



meanBPMPositions = NaN*ones(nBPMsToPlot,nDataSets); 
for i=2:nDataSets
    for b=ccIndexes
        meanBPMPositions(b,i) = nanmean(bpmPositions(b,i,ccRange));
    end
    for b=cbIndexes
        meanBPMPositions(b,i) = nanmean(bpmPositions(b,i,cbRange));
    end
    plot(meanBPMPositions(:,i),'Color',dataSetColours(i,:),'LineWidth',2);
    hold all;
end
[~,objh,~,~] = legend(dataSetLabels{2:nDataSets});
set(objh,'linewidth',2);
grid on;
title('Horizontal Beam Orbit');
xlabel('BPM Index');
ylabel('Difference to Nominal Orbit [mm]');

%% Phase



%% Trying to understand results from relative timing scan
% dataSetLabels = {
%     'Delay K1=0 K2=0',...
%     'Delay K1=0 K2=2',...
%     'Delay K1=0 K2=4',...
%     'Delay K1=0 K2=6',...
%     'Delay K1=0 K2=8',...
%     'Delay K1=0 K2=10',...
%     'Delay K1=2 K2=0',...
%     'Delay K1=4 K2=0',...
%     'Delay K1=6 K2=0',...
%     'Delay K1=8 K2=0',...
%     'Delay K1=10 K2=0'...
% };
% 
% dataSetColours = [...
%     0, 0, 0;...
%     0, 0, 1;...
%     1, 0, 0;...
%     0, 0.5, 0;...
%     0.5, 0, 0.9;...
%     1, 0.6, 0;...  
%     0, 0, 1;...
%     1, 0, 0;...
%     0, 0.5, 0;...
%     0.5, 0, 0.9;...
%     1, 0.6, 0];    
%     
% dataSetStyles = {...
%     '-';...
%     '-';...
%     '-';...
%     '-';...
%     '-';...
%     '-';...  
%     '--';...
%     '--';...
%     '--';...
%     '--';...
%     '--'};    
% 
% dataSetWidths = [...
%     3,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2,...
%     2];
% 
% 
% 
% plot(bpmPositions{2}+bpmPositions{3})
% 
% kick1 = bpmPositions{2};
% kick2 = bpmPositions{3};
% figure;
% i=0;
% for delay2=0:2:10
%     i=i+1;
%     delayKick2 = circshift(kick2,delay2,2);
%     plot(kick1+delayKick2,'Color',dataSetColours(i,:),'LineStyle',dataSetStyles{i},'LineWidth',dataSetWidths(i));
%     hold all;
% end
% for delay1=2:2:10
%     i=i+1;
%     delayKick1 = circshift(kick1,delay1,2);
%     plot(delayKick1+kick2,'Color',dataSetColours(i,:),'LineStyle',dataSetStyles{i},'LineWidth',dataSetWidths(i));
%     hold all;
% end
% legend(dataSetLabels);
% xlim([410 490])
% title('Expected response to different delays');

%% Trying to simulate results from a relative timing scan
% 
% p1 = zeros(1,100);
% p2 = -sin((pi/2):0.1:(3.*pi/2))+1;
% p3 = 2*ones(1,50);
% p4 = -sin((3.*pi/2):0.1:(5.*pi/2))+1;
% p5 = zeros(1,100);
% kick1 = [p1 p2 p3 p4 p5];
% kick2 = -kick1;
% 
% figure;
% i=0;
% for delay2=-40:2:40
%     i=i+1;
%     delayKick2 = circshift(kick2,delay2,2);
%     
%     subplot(2,1,1)
%     plot(kick1);
%     hold all;
%     plot(delayKick2);
%     hold off;
%     title(sprintf('%d',delay2));
%     
%     subplot(2,1,2)
%     plot(kick1+delayKick2);
%     %hold all;
%     ylim([-2 2]);
%     pause(0.5);
%     %input(sprintf('%d',delay2));
% end
% % for delay1=2:2:10
% %     i=i+1;
% %     delayKick1 = circshift(kick1,delay1,2);
% %     plot(delayKick1+kick2,'Color',dataSetColours(i,:),'LineStyle',dataSetStyles{i},'LineWidth',dataSetWidths(i));
% %     hold all;
% % end
% %legend(dataSetLabels);
% %xlim([410 490])
% %title('SIMULATED');
